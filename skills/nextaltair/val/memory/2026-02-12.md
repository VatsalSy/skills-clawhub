# 2026-02-12

- Calibre metadata運用を実地で安定化。
  - ID462: `title_sort`/`author_sort` をカタカナで反映確認。
  - ID418: 発行者/発行日/著者/タグ更新と sort 反映。
  - ID290: 論文メタ（title/authors/publisher/series/tags/sort）反映。
  - ID422: 家電マニュアルとして再同定し反映。ユーザー指定で `OLED` 読みを `オーエルイーディー` に統一。最終的にシリーズ/巻数は削除。

- `calibre-metadata-apply` スキル方針を更新:
  - 解析段は `sessions_spawn` で軽量subagentモデルを使うことを必須化（mainは承認・apply担当）。
  - 欠損メタ（publisher/pubdate等）は Web候補 + ファイル根拠で提案し、ユーザー承認後のみ適用。
  - sort読み仮名のデフォルトは「フル読み（省略なし）」に統一（ユーザー設定 `reading_script=katakana` を再利用）。

- ドキュメント整理:
  - `calibre-metadata-apply/SKILL.md` を再構成して重複を削減（必須フロー/責務分離/禁止事項を明確化）。
  - README を日本語化。
  - README にユーザー事前作業として OpenClaw実行環境で `calibre` と `pdffonts`（`poppler-utils`）をインストールする手順を追記。

- リリース節目:
  - `calibre-metadata-apply` に `v1.0.0` タグ付与（1冊ずつのメタデータ編集ワークフロー完成）。

- 次フェーズ方針（ユーザー合意）:
  - ライブラリ横断処理は本文を読まず、既存メタデータのみで推定。
  - 解析は軽量subagentのみ（mainで重解析しない）。
  - ユーザー承認なしでの自動適用を許容。ただし高確信のみ適用。
  - 初回実験として「manual/マニュアル」タグ自動付与を実施。

- 実地テスト結果（横断）:
  - メタデータのみ判定で高確信マニュアル候補を抽出し、55冊に `マニュアル` + `Manual` を自動付与。
  - 適用結果: 55件成功/失敗0。
  - 補足: 一部に誤爆候補（例: 学術系タイトル）が混ざり得るため、除外ルール薄入れの余地あり。

- 長時間ジョブ運用を実装:
  - ライブラリ横断の重い処理はターン分割（開始ACK→完了通知）で実行する方針を採用。
  - `calibre-metadata-apply` に run state 管理を追加。
    - `scripts/run_state.py`
    - `scripts/handle_completion.py`
    - state保存先 `state/runs.json`
  - SKILL/READMEに Turn1/Turn2 フローを明記（チャット継続性を確保）。

- 表記/運用調整:
  - ユーザー要望で `README.md` は日本語、`SKILL.md` は英語に分離統一。
  - サブエージェント開始時に「subagent経由」と「実行モデル名」を明示する運用をSKILLへ追記。
  - `state/runs.json` はランタイム生成物として `.gitignore` に追加。

- ターン分割テスト（論文タグ）:
  - ライブラリ全件メタデータのみを対象に、軽量subagentで `論文` 高確信候補抽出を実行。
  - 候補は約53件規模で「結果は良好」とユーザー確認。
  - 併せて、セッション一覧表示モデルと実際のsubagent実行モデルがズレて見える場合があるため、実ログで `provider/model` を確認する運用を共有。

- `calibre-metadata-apply` 追加運用決定:
  - サブエージェント起動時は、開始メッセージに「subagent経由」と「実行モデル名」を必ず明示する。
  - `state/runs.json` はランタイム状態のため `.gitignore` へ追加済み。
  - README目的セクションを拡張（スコープ/境界/ユースケース/運用ポリシー）。
  - バージョンタグ更新: `v1.1.0`（ライブラリ横断一括タグ付け対応）。

- M3（Unknown Document Recovery）方針を確定:
  - 目的: 素性不明・意味不明タイトル文書の再同定とメタ再設定。
  - ユーザー介入タイミングを固定:
    1) 軽量パス（メタデータのみ）を**必ず自動実行**
    2) 解析結果と推奨データを表で提示し、ここで停止
    3) ユーザー指示がある場合のみ、1ページ目解析へ進む
    4) まだ不確実なら前後5P + Web検索の詳細調査
    5) 詳細結果提示後、承認を得てからapply
  - これをSKILLに反映（`50db757`, `118d862`）。

- M3実地テスト:
  - ID83で「軽量→1ページ目→apply」フロー実施。
  - タイトルを `ROG CROSSHAIR VIII IMPACT User Manual` に更新し、著者/発行者/タグを適用。
  - 読み仮名更新: `title_sort=アールオージー クロスヘア エイト インパクト ユーザーマニュアル`, `author_sort=エイスース`。

- 追加棚卸し:
  - 「タグなし」かつ「タイトル意味不明」候補を抽出し、142件を検出（高スコア候補あり）。
  - ユーザー要望に合わせ、M3の軽量解析結果は必ず表形式で提示してから次段階へ進む運用を徹底。

- LOW群の次段階解析（1ページ目）を実施:
  - 対象16件（ID257,264,278,279,283,383,403,411,417,421,688-692,702）。
  - ID264はユーザー承認で適用済み:
    - title=`高い敏感性をもつ子ども (Highly Sensitive Child) の理解`
    - authors=`串崎 真志`
    - publisher=`関西大学人権問題研究室`
    - tags=`論文`,`心理学`
  - ID257はdeep調査でも発行主体の確定不能（文書種別のみ判別）。
  - 人手評価で追加判断:
    - ID383: Qcells住宅用太陽光発電システムのカタログと判別可
    - ID417: 文字埋め込みなし図面で現行枠組みでは解析不能（OCR版で対応）
    - ID421: SeagateのRMA申込書と判別可だが、適切タイトル自動命名は次版機能へ

- 今後の機能分離方針（ユーザー合意）:
  - OCR対応は別バージョンで実装
  - 表題が曖昧な文書の「意味的タイトル自動命名」も別バージョンで実装

- 保留運用を英語タグに統一:
  - 保留タグ標準を `pending-review` に決定
  - ID257 / ID417 / ID421 に `pending-review` を適用済み

- スキル文書運用ルールを追加（ユーザー明示）:
  - `agents.list` はユーザーが手動で設定/管理する前提。
  - この変更の説明は各スキル `README.md` に記載する。
  - `sessions_spawn` の引数方針（必須/推奨）は各スキル `SKILL.md` に記載する。
  - 対応として `calibre-catalog-read` / `calibre-metadata-apply` / `soul-in-sapphire` のREADME/SKILLを更新済み。

- `soul-in-sapphire` 実地テストで不具合を再現・修正:
  - 症状1: `ltm_write.py` / `ltm_search.py` が `Config missing data_source_id` で失敗。
  - 原因1: `~/.config/soul-in-sapphire/config.json` の新形式（`mem.database_id` / `mem.data_source_id`）に Python 側が未対応。
  - 修正1: `scripts/ltm_common.py` で互換処理を追加し、root keys欠如時は `mem.*` から補完するよう変更。
  - 症状2: Notion API が `invalid_request_url (400)` を返して失敗。
  - 原因2: `scripts/notion_http.py` が `/v1` プレフィックスなしのURLを組み立てていた。
  - 修正2: `http_json()` で API path を正規化し、先頭 `/v1/` がない場合は自動付与するよう変更。
  - 検証結果: 修正後に LTM write/search のスモークテスト成功、`emostate_tick.js` も実行成功を確認。

- subagent運用/権限まわりの実地確認:
  - `agents.list` にIDを置くだけではspawn不可で、`main.subagents.allowAgents` の明示が必要。
  - `soul-heartbeat` 実行確認: model=`google/gemini-flash-lite-latest`。
  - `soul-journal` 実行確認: model=`openai-codex/gpt-5.3-codex`。

- cross-agent参照設定を有効化:
  - `tools.agentToAgent.enabled=true` を適用し、allowに `main/soul-heartbeat/soul-journal` を設定。
  - Gateway再起動後、`sessions_history` で別agentセッション履歴参照が可能になったことを確認。

- 追加トラブルシュート知見:
  - 18:52頃の `claude-opus-4-6` 呼び出し失敗は通常会話ではなく、内部 `llm-slug-generator`（session-memoryのslug生成）レーン起因。
  - ログ上で `session:temp:slug-generator` が `provider=anthropic model=claude-opus-4-6` を選択し、Anthropic課金不足(402)で失敗していることを確認。

- subagent運用方針の整理:
  - `agents.list` は「複数独立agent運用」の設定で、subagent分担だけを目的に使うと過剰になりやすいという認識で一致。
  - single-agent運用では、subagent向け設定は `sessions_spawn` payload生成を分離したほうが扱いやすい。

- 新規スキル作成:
  - `~/.openclaw/mediaops/val/skills/subagent-spawn-command-builder` を新設。
  - 目的は `sessions_spawn` を実行せず、payload(JSON)のみを生成すること。
  - 公式パラメータに対応する方針に更新（`task,label,agentId,model,thinking,runTimeoutSeconds,cleanup`）。
  - `state/spawn-profiles.template.json` + `scripts/build_spawn_payload.py` でプロファイル駆動生成。
  - 生成payloadを使った実地疎通で `sessions_spawn` 成功を確認（期待応答 `spawn-payload-ok`）。

- ドキュメント/リポ運用:
  - `soul-in-sapphire` は SKILL英語・README日本語の方針で再整理。
  - `soul-in-sapphire/.gitignore` の誤編集で外れていた `bootstrap_config.py` / `ltm_search.py` を追跡復帰。
  - `skills` リポジトリで `subagent-spawn-command-builder` をコミット済み。
  - タグ `subagent-spawn-command-builder-v1.0.0` を作成済み。

- 新スキル `subagent-spawn-command-builder` の方針確定:
  - 役割は `sessions_spawn` の実行ではなく「payload/command JSON生成のみ」。
  - 配布/汎用性のため、公式 `sessions_spawn` パラメータ一式に対応する設計へ更新。
  - `soul-in-sapphire` 側はこの共通builderを参照する構成に変更（ローカル専用planner依存を解消）。
  - 疎通テスト結果: builder出力payloadで `sessions_spawn` 実行成功（期待応答 `builder-test-ok`）。

- README更新方針:
  - `soul-in-sapphire/README.md` に `subagent-spawn-command-builder` 依存を明記し、
    `npx clawhub@latest install ...` / `pnpm dlx clawhub@latest install ...` の導入コマンドを追記。

- `calibre-catalog-read` のbuilder連携を反映:
  - `SKILL.md` を `subagent-spawn-command-builder` 前提に更新。
  - `README.md` も依存/手順を builder経由に更新。
  - スキル挙動テストとして、builderで `calibre-read` payload生成 -> `sessions_spawn` で実読書要約を実行し、期待どおり結果を確認。

- コスト最適化:
  - `skills/subagent-spawn-command-builder/state/spawn-profiles.json` の `calibre-read.model` を
    `openai-codex/gpt-5.3-codex` から `openrouter/moonshotai/kimi-k2.5` へ変更。

- calibre読書テスト追加:
  - 別書籍(ID2: 天使の囀り)で builder経由のspawnを実施し、`modelApplied=true` で起動を確認。
  - ただし結果が `(no output)` になり、原因候補として `python` コマンド未定義エラーを確認。

- 対策(実装反映済み):
  - subagent実行文脈で Python 呼び出しは `python3` 固定とするルールを明記。
  - 反映箇所:
    - `calibre-catalog-read/references/subagent-analysis.prompt.md`
    - `calibre-catalog-read/SKILL.md`
    - `subagent-spawn-command-builder/SKILL.md`
    - `subagent-spawn-command-builder/README.md`

- 追加検証(2026-02-12 夜):
  - `calibre-read` プロファイルで `runTimeoutSeconds=300` / 呼び出し `timeoutSeconds=360` に延長して再テスト。
  - 別書籍(ID4)で builder -> spawn 実行は成功するが、結果は再度 `(no output)`。
  - 観測上、タイムアウトよりもモデル相性の可能性が高い。
  - 直前に成功していたケースは `gpt-5.3-codex`、失敗連発は `kimi-k2.5` へ切替後。

- `read tool called without path` 警告への対応:
  - 原因候補として、subagent側の read 呼び出し引数不備（pathなし）を確認。
  - `calibre-catalog-read` の prompt/SKILL/README に厳格read契約（`{"path":"..."}`必須）を明記。
  - ただし厳格化後も `kimi-k2.5` では `(no output)` が継続。

- モデル比較結果:
  - 同一系タスクを `openrouter/qwen/qwen3-next-80b-a3b-instruct` で実行すると `SUMMARY:` 形式で正常出力。
  - 現時点の暫定判断: フロー不具合より、`kimi-k2.5` と当該タスク条件の相性問題が濃厚。

- `calibre-catalog-read` 現在の残タスク整理:
  - 変更ファイル3点（README/SKILL/prompt）が未コミット。
  - builder依存前提に対して、`spawn-profiles.json` の `profiles.calibre-read` 作成案内が不足。
  - READMEの `agents.list` 節はbuilder中心運用に合わせて簡略化余地あり。

- その後の反映:
  - `calibre-catalog-read` は README/SKILLともに `subagent-spawn-command-builder` でのスキル呼び出し表記へ統一。
  - `calibre-metadata-apply` も builder対応へ変更（依存追加、ターン分割の開始手順をbuilder経由化、`calibre-meta` プロファイル例を追記）。

- モデル固定方針の確定:
  - `subagent-spawn-command-builder/state/spawn-profiles.json` で `calibre-read` と `calibre-meta` の model を
    `openrouter/qwen/qwen3-next-80b-a3b-instruct` に設定。
  - `calibre-meta` プロファイルで payload生成→`sessions_spawn` 実行テストを行い、期待応答で正常動作を確認。

- スキル独立性の修正（相互依存の解消）:
  - ユーザー要望「2つのスキルは互いに依存しない」に対応。
  - `calibre-catalog-read/scripts/run_analysis_pipeline.py` から `calibre-metadata-apply/scripts/calibredb_apply.py` 呼び出しを削除し、`calibredb set_metadata` でコメント反映を自己完結化。
  - `calibre-catalog-read/scripts/calibredb_read.mjs` の既定authキャッシュを `~/.config/calibre-catalog-read/auth.json` に分離（従来は metadata側パスを参照）。
  - `calibre-catalog-read/SKILL.md` と `calibre-metadata-apply/SKILL.md` にスタンドアロン動作の方針を明記。
  - 最低限の構文チェック実施: `python3 -m py_compile`（pipeline）/ `node --check`（read script）ともに通過。
