# 2026-02-11

- Investigated cron alert: `issue: expected paths missing (inventory + move_plan)` for `unwatched_auto_organize_0430`.
- Finding: not a pipeline failure; `rotate_move_audit_logs.py` moves non-kept `*.jsonl` in `/mnt/b/_AI_WORK/move/` into `archive/` and gzips them.
  - `inventory_unwatched_20260211_043008.jsonl` and `move_plan_from_inventory_20260211_043009.jsonl` were missing from root because they were archived as:
    - `B:\_AI_WORK\move\archive\inventory_unwatched_20260211_043008.jsonl.gz`
    - `B:\_AI_WORK\move\archive\move_plan_from_inventory_20260211_043009.jsonl.gz`
- Both gz files contained only a single `_meta` line (no inventory rows, no plan rows), consistent with "nothing to move".
- Actionable improvement: adjust either
  1) cron check logic to accept `archive/*.jsonl.gz` as satisfying "expected paths", or
  2) update `rotate_move_audit_logs.py` keep set to also keep latest `inventory_unwatched_*.jsonl` and `move_plan_from_inventory_*.jsonl` in root for readability and to prevent false alerts.
- Applied fix in `mediaops/rotate_move_audit_logs.py`: keep latest `inventory_unwatched_*.jsonl` and `move_plan_from_inventory_*.jsonl` in root and list them in `MANIFEST.md` to avoid false missing-path alerts.
- Verified `openai-codex/gpt-5.3-codex` works via explicit run (`runId b167a344-03ed-4332-8e94-598796906244`); log shows `embedded run start ... model=gpt-5.3-codex` and successful completion.
- Updated Gateway config per user request: `agents.defaults.model.primary` switched from `openai-codex/gpt-5.2` to `openai-codex/gpt-5.3-codex` (config.patch applied and gateway restart succeeded).
- Heartbeat model test confusion root cause: heartbeat can be skipped when `HEARTBEAT.md` is effectively empty (comments/headings only), so no model invocation occurs even if heartbeat is started.
- Fixed stale references in `skills/soul-in-sapphire/` and committed:
  - updated setup guidance from `setup_ltm.py` to `setup_ltm.js` in `SKILL.md` + `scripts/emostate_config.py`
  - kept journal writer fallback for optional missing properties (`highlights` / `links`)
  - added `.gitignore` in skill directory
  - commit: `530f8d6`
- Calibre automation direction clarified:
  - User confirmed using Calibre Content server path from WSL context.
  - Decided to split into two independent skills (no runtime dependency between them):
    1) `calibre-catalog-read` (read + one-book analysis/cache/comments workflow)
    2) `calibre-metadata-apply` (controlled metadata edits by user intent)
- `calibre-catalog-read` evolved to JS read script (`calibredb_read.mjs`) and integrated pipeline:
  - `scripts/run_analysis_pipeline.py` (export -> analyze -> cache -> comments apply)
  - `scripts/analysis_db.py` (SQLite cache)
  - subagent prompt/schema templates added under `references/`
- `calibre-metadata-apply` expanded:
  - comments HTML marker upsert (`OC_ANALYSIS_START/END`)
  - multi-tag merge/dedupe
  - localized labels (`ja` default, optional `en`, record-level `analysis.lang`)
- Connectivity/auth findings:
  - WSL could not reach `127.0.0.1:8080`; remote host URL (`192.168.11.20:8080`) worked.
  - Auth path validated; initial write failures traced to Windows path/security (`WinError 2`) and later resolved.
  - Documented Defender Controlled Folder Access caveat in READMEs.
- Repo boundary decision:
  - User requires commits for `calibre-catalog-read` in its own git repo (`~/clawd/skills/calibre-catalog-read`) with separate remote.
  - Workspace repo now ignores `skills/calibre-catalog-read/` and untracks it from workspace index.
- Subagent model control:
  - `sessions_spawn` initially rejected requested models (`model not allowed`) until user updated gateway allowlist and restarted.
  - Post-update check succeeded (`modelApplied: true` for `google/gemini-flash-lite-latest`).
- Production-flow test executed:
  - Full path run performed with analysis JSON input and metadata apply success.
  - Noted that empty extracted text can produce weak summaries; subagent/analysis-json path is preferred over fallback.
- New guardrail added in read pipeline:
  - Manga/comic-centric titles are excluded by title/tag keywords to avoid high-cost low-quality text-only analysis.
  - Verified skip on manga-tagged book (`excluded_content`).
- Added low-text confirmation gate in read pipeline:
  - If extracted text is below threshold, pipeline returns `low_text_requires_confirmation` and does not auto-apply.
  - Includes English prompt for user confirmation; proceed only with explicit override (`--force-low-text`).
- Verified subagent model allowlist behavior:
  - Before gateway update: requested subagent models were rejected (`model not allowed`).
  - After user updated allowlist + restarted gateway: spawn accepted with `modelApplied: true` for `google/gemini-flash-lite-latest`.
- Production-flow execution notes:
  - End-to-end run succeeded (subagent analysis JSON -> pipeline apply -> Calibre comments HTML updated).
  - A slow listener warning appeared (`MESSAGE_CREATE` ~87s), indicating heavy turn blocking risk.
  - Decision: enforce strict Main/Subagent split in skill to keep main listener lightweight and move heavy analysis to subagent.
- Skill policy update committed in subrepo:
  - `ec82280` clarifies strict main vs subagent responsibilities to reduce blocking latency.
- Further docs clarification added:
  - `caa17cf` explicitly states `sessions_spawn` must be orchestrated by main agent layer; local pipeline script does not call OpenClaw tools directly.
- Subagent configuration UX updated:
  - `7c861c2` changed policy to confirm model/thinking/timeout once per session, then reuse unless user requests changes.
- Read tool stability finding:
  - Large single-line `subagent_input.json` can trigger read-size issues/warnings (line size around 50KB limit).
  - Adopted chunked source-file approach for subagent input.
- Implemented chunked subagent input prep in `calibre-catalog-read`:
  - new `scripts/prepare_subagent_input.py` splits extracted text into multiple `excerpt_part_*.txt` files and writes `subagent_input.json` with `source_files` array.
  - updated prompt template and docs to read all `source_files` in order.
  - commit: `fdf3d8e`.
- Additional stability hardening for subagent reads:
  - Added `references/subagent-input.schema.json` with strict input contract.
  - Strengthened prompt with strict read contract (`{"path":"..."}` only, no `file_path`, no offset/limit paging).
  - Added failure-output discipline and raw-JSON-only response rules.
  - commit: `2296681`.
- Runtime observation:
  - Even after chunking, long/iterative subagent read loops can still trigger `read tool called without path` warnings due to tool-call argument drift.
  - Decided to reduce this risk via stricter schema+prompt constraints and simplified read flow.
- Operational note explained to user:
  - `_skill_audit` = quarantine/staging area to inspect third-party skills before promoting to `skills/`.
  - `workspaceState.state.json` = workspace index/cache (folders + symbol map), not primary data; generally safe to regenerate.
- Discord listener latency troubleshooting (Calibre production flow):
  - User observed repeated `Slow listener detected` warnings (~67-99s) during book-analysis runs and occasional read offset EOF errors (`Offset 148 is beyond end of file`).
  - Confirmed root cause split: slow-listener issue was main-turn blocking (waiting/polling/apply in one turn), not Discord-specific; offset error was subagent read-behavior/tool-call pattern noise.
- Agreed operating model with user:
  - Enforce split turns for chat UX: Turn A = immediate ACK + spawn, Turn B = completion/apply report.
  - Keep normal conversation flowing while analysis runs; do not block a single listener turn.
- Skill docs updated to codify split-turn behavior:
  - commit `d4e8208`: added required async two-phase interaction pattern to `calibre-catalog-read/SKILL.md`.
  - commit `f157ac5`: enforced split-turn chat operation in `SKILL.md` + `README.md`.
- New production run after split-turn doc updates:
  - Selected new non-duplicate EPUB/non-comic title: id=33 `地球から来た男 (角川文庫)`.
  - Subagent model override attempts showed allowlist constraints (`qwen3-next-80b-a3b-instruct:free` not allowed; `google/gemini-3-pro-preview` not allowed); succeeded with `openai-codex/gpt-5.3-codex` (`modelApplied: true`).
  - End-to-end apply succeeded: DB cache + Calibre comments HTML updated (`applied=1, failed=0`).
- OpenClaw behavior clarified to user from docs:
  - `sessions_spawn` itself is non-blocking and returns accepted immediately.
  - Main session runs are serialized per session lane; if main turn keeps working, announce messages queue as "while agent was busy".
  - Therefore queued completion announcements are expected when main turn is occupied.
- User approved immediate skill update (no deferral) for simpler one-book state handling.
- `calibre-catalog-read` updated for single-file run state policy using `runId` as primary key:
  - commit `a47ebf3` adds required `runs.json` lifecycle rules in `SKILL.md` and tracks `state/` via `.gitkeep`.
- End-to-end validation run executed with new title `id=34 おかしな先祖`:
  - Spawn accepted (`runId` captured), analysis completed, DB/comments apply succeeded, and state cleared.
  - Confirmed final state file became empty (`{"runs": {}}`) after successful apply.
- Test harness bug encountered and resolved:
  - Initial inline Python state write failed with `KeyError: 'RUN_ID'` due to missing env export in shell wrapper.
  - User requested hardening; implemented safer dedicated state helper instead of ad-hoc env usage.
- Added deterministic state helper script and docs:
  - commit `bdd76be` adds `scripts/run_state.py` with `upsert/get/remove/fail` subcommands and updates `SKILL.md` examples.
  - Verified commands locally (`upsert -> get -> remove -> get`) with expected results.
- Re-test after hardening completed successfully on new book `id=35 逃げる百姓、追う大名 江戸の農民獲得合戦 (中公新書)`:
  - `run_state.py upsert` created active run entry by `runId`.
  - analysis/apply succeeded (`applied=1, failed=0`).
  - `run_state.py remove` cleared run entry (`run: null`).
- User flagged remaining core issue: despite state safety, flow still tended to act like start→result in one continuous operation from UX perspective; requested stricter two-turn behavior and cleanup of dead artifacts.
- Enforced strict two-turn contract and pruned unused artifact in `calibre-catalog-read`:
  - commit `a118589`.
  - `SKILL.md`: replaced duplicated async sections with a single strict "Chat execution model".
    - Turn A: select/spawn/upsert/ack and stop.
    - Turn B: completion-triggered get/apply/remove-or-fail.
    - Explicitly forbids wait/poll/apply in Turn A.
  - `README.md`: updated to required two-turn operation with `run_state.py` commands.
  - `.gitignore`: added `state/runs.json` and `*.pyc` to avoid committing runtime/generated files.
  - Removed unused `references/config.example.json` (unreferenced/dead file).
- Live verification of strict start/complete behavior:
  - Started new run on `id=53 月の影 影の海 十二国記(上)` with immediate start ack and background processing.
  - Completion announce arrived separately with valid analysis payload, confirming practical two-turn operation in chat.
- User confirmed perceived resolution after live run (background subagent work + later result delivery acceptable).
- CLI note captured for user ops:
  - Practical way to inspect active/recent subagents is `openclaw sessions --active <minutes> --json` filtered by keys containing `:subagent:` (e.g., via `jq`).
- Additional operational fix after live run:
  - A completion reply miss still occurred once even though analysis finished; root cause was non-atomic/manual completion handling path.
  - Implemented single-command completion handler to enforce the sequence.
- New script added to `calibre-catalog-read`:
  - `scripts/handle_completion.py` (commit `f544627`).
  - Behavior: `get(runId) -> apply(run_analysis_pipeline) -> remove(runId)` on success; `fail` on error; returns `stale_or_duplicate` if run missing.
- Validated `handle_completion.py` with real book run:
  - Test book `id=54 月の影影の海: 十二国記(下)`.
  - First execution intentionally/accidentally failed due to missing `CALIBRE_PASSWORD` in environment; handler marked failed as designed.
  - Re-run with proper env succeeded and auto-removed run entry; DB/comments updated.
- User asked about subagent model mismatch (expected Kimi 2.5, observed GPT-5.3):
  - Confirmed config has `agents.defaults.subagents.model.primary = openrouter/moonshotai/kimi-k2.5`.
  - Live spawn test without explicit model returned warning: `model not allowed: openrouter/moonshotai/kimi-k2.5`.
  - Conclusion: config value exists but model is rejected by model catalog/allow policy; need allowlist/catalog alignment.
- Docs pointers shared for policy/allowlist understanding:
  - `/gateway/configuration`, `/tools/subagents`, `/gateway/doctor`.
- User requested another live run after possible model-policy fix; executed book read start flow on `id=55 黄昏の岸 暁の天`.
  - Spawn accepted and run state upserted (`runId=4a471ac9-c86c-4fbb-8aa4-bfb37d9805d3`).
  - Completion announce arrived later with full analysis payload.
- User observed subagent model still showing `gpt-5.3-codex` and questioned config mismatch.
- Investigation summary:
  - `~/.openclaw/openclaw.json` contains correct subagent defaults (`openrouter/moonshotai/kimi-k2.5`) and model catalog includes Kimi/Qwen.
  - `openclaw models status --json` shows allowed list includes Kimi and OpenRouter auth profile present.
  - Prior direct spawn test had returned `model not allowed: openrouter/moonshotai/kimi-k2.5`; later behavior suggested possible stale gateway runtime / override path.
- Guidance given:
  - verify allowed list via `openclaw models status --json | jq '.allowed'`
  - restart gateway (`openclaw gateway restart`) and re-test spawn without explicit model
  - if still 5.3, inspect call path for explicit model override in run prompt/skill logic.
- User requested explicit CLI prompt test to Kimi-k2.5.
  - Verified by temporarily switching default model with `openclaw models set openrouter/moonshotai/kimi-k2.5`, running `openclaw agent --agent main ... --json`, then restoring default to GPT-5.3.
  - Confirmed response and metadata showed provider/model `openrouter / moonshotai/kimi-k2.5`.
- User requested another live skill run after suspected restart/config fix.
  - Started new run on `id=56 十二国記 風の万里 黎明の空（上）`.
  - Spawn accepted (`runId=0212398a-39f3-4cf5-97d1-920c6d70896a`) and session list confirmed subagent model is now `moonshotai/kimi-k2.5`.
- Noted state detail during run56 start:
  - `run_state.py upsert` reported `count: 2`, implying at least one prior run entry remained in `runs.json` (requires later cleanup/reconciliation after completion handling).
- Later user feedback corrected doc direction:
  - README should be Japanese.
  - Runtime model-policy troubleshooting (OpenClaw setting/user ops) should not live in this skill README.
- Applied README correction in `calibre-catalog-read`:
  - commit `e5af05b`.
  - Rewrote README in Japanese and removed non-skill runtime troubleshooting section.
  - Kept only skill-relevant guidance (setup, one-book pipeline, chunking, low-text safeguard, mandatory two-turn operation).
- `calibre-metadata-apply` hardening and workflow evolution (subrepo):
  - Added target narrowing + user confirmation mandatory flow before apply (`c081b78`).
  - Added persistent reading-script policy for sort fields; user preference set to `katakana` in `~/.config/calibre-metadata-apply/config.json` (`b5aba78`).
  - Added support for `title_sort` / `author_sort` updates in apply script and docs (`48e8b7d`).
  - Added `tags_remove` field for explicit user-driven tag deletion (`f0f069e`).
  - Added explicit sessions_spawn lightweight subagent policy for analysis stage (`760adb8`).
  - Added web bibliographic candidate approval gate for missing publisher/pubdate/journal-like fields (`bacc410`).
  - Proposal output policy updated around sort-reading candidates (`6b9767c`, `bd2042b`), then simplified by user feedback (title_reading candidate redundant).
  - Sort reading default policy set to full reading (no truncation) unless explicitly requested (`978ff35`).
  - PDF extraction policy fixed: `ebook-convert` first, fallback to `pdftotext`, then web-first if both fail (`bf3dfb7`).
- Operational tests executed successfully for metadata-apply workflow:
  - ID 824 corrected from wrong manual metadata to article metadata; later tag pruning applied; sort fields added.
  - ID 462 corrected title/authors/tags and sort fields after extractor fallback debugging.
  - ID 418 corrected author/publisher/date/tags and full title_sort+author_sort.
  - ID 290 corrected title/authors/publisher/series/tags and sort fields.
  - ID 422 tested with subagent analysis on lightweight model and applied with user-preferred reading `OLED => オーエルイーディー`.
- Important runtime finding:
  - `ebook-convert` can return empty text on some Japanese PDFs even when text layer exists; `pdftotext` successfully extracted the same file (ID462). Root cause attributed to extractor/font mapping compatibility, not absence of text content.
- Model policy/debug findings:
  - Earlier subagent model mismatch traced to runtime/policy state rather than skill logic; later verification showed subagent sessions running on `moonshotai/kimi-k2.5` after environment alignment.
- Heartbeat/emostate wiring:
  - User requested heartbeat reminder in soul-in-sapphire; SKILL updated in subrepo (`42203e3`).
  - HEARTBEAT.md was updated to minimal user-preferred form and frequency note (`soul-in-sapphire を使う / 30分ごと`).
