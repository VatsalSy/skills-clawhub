{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://consensus.tools/schemas/permission-escalation-guard-input.json",
  "title": "consensus-permission-escalation-guard input",
  "type": "object",
  "additionalProperties": false,
  "required": ["board_id", "proposed_escalation"],
  "properties": {
    "board_id": { "type": "string", "minLength": 1 },
    "persona_set_id": { "type": "string", "minLength": 1 },
    "mode": { "type": "string", "enum": ["persona", "external_agent"] },
    "external_votes": {
      "type": "array",
      "items": { "$ref": "#/$defs/externalVote" }
    },
    "constraints": { "$ref": "#/$defs/constraints" },
    "proposed_escalation": { "$ref": "#/$defs/proposedEscalation" }
  },
  "allOf": [
    {
      "if": {
        "properties": { "mode": { "const": "external_agent" } },
        "required": ["mode"]
      },
      "then": { "required": ["external_votes"] }
    }
  ],
  "$defs": {
    "constraints": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "require_ticket": { "type": "boolean", "default": true },
        "require_justification": { "type": "boolean", "default": true },
        "require_expiry_for_temporary": { "type": "boolean", "default": true },
        "max_temporary_duration_minutes": { "type": "integer", "minimum": 1, "default": 240 },
        "block_wildcard_permissions": { "type": "boolean", "default": true },
        "production_requires_human_confirm": { "type": "boolean", "default": true },
        "forbid_break_glass_without_incident": { "type": "boolean", "default": true }
      }
    },
    "proposedEscalation": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "request_id",
        "environment",
        "subject",
        "resource",
        "change",
        "justification",
        "requested_at"
      ],
      "properties": {
        "request_id": { "type": "string", "minLength": 1 },
        "environment": { "type": "string", "enum": ["dev", "staging", "prod"] },
        "requested_at": { "type": "string", "format": "date-time" },
        "ticket_ref": { "type": "string", "minLength": 1 },
        "incident_ref": { "type": "string", "minLength": 1 },
        "justification": { "type": "string", "minLength": 8, "maxLength": 2000 },
        "subject": {
          "type": "object",
          "additionalProperties": false,
          "required": ["type", "id"],
          "properties": {
            "type": { "type": "string", "enum": ["user", "service_account", "role"] },
            "id": { "type": "string", "minLength": 1 },
            "team": { "type": "string", "minLength": 1 },
            "manager_id": { "type": "string", "minLength": 1 }
          }
        },
        "resource": {
          "type": "object",
          "additionalProperties": false,
          "required": ["system", "resource_id"],
          "properties": {
            "system": { "type": "string", "minLength": 1 },
            "resource_id": { "type": "string", "minLength": 1 },
            "tenant_id": { "type": "string", "minLength": 1 }
          }
        },
        "change": {
          "type": "object",
          "additionalProperties": false,
          "required": ["kind", "requested_permissions", "temporary"],
          "properties": {
            "kind": { "type": "string", "enum": ["grant", "expand_scope", "assume_role"] },
            "current_permissions": {
              "type": "array",
              "items": { "type": "string", "minLength": 1 },
              "uniqueItems": true
            },
            "requested_permissions": {
              "type": "array",
              "items": { "type": "string", "minLength": 1 },
              "minItems": 1,
              "uniqueItems": true
            },
            "temporary": { "type": "boolean" },
            "expires_at": { "type": "string", "format": "date-time" },
            "duration_minutes": { "type": "integer", "minimum": 1 },
            "break_glass": { "type": "boolean", "default": false }
          }
        }
      }
    },
    "externalVote": {
      "type": "object",
      "additionalProperties": false,
      "required": ["persona_id", "name", "reputation_before", "vote", "confidence", "reasons", "red_flags", "suggested_edits"],
      "properties": {
        "persona_id": { "type": "string", "minLength": 1 },
        "name": { "type": "string", "minLength": 1 },
        "reputation_before": { "type": "number", "minimum": 0.05, "maximum": 0.95 },
        "vote": { "type": "string", "enum": ["YES", "NO", "REWRITE"] },
        "confidence": { "type": "number", "minimum": 0, "maximum": 1 },
        "reasons": { "type": "array", "items": { "type": "string" } },
        "red_flags": { "type": "array", "items": { "type": "string" } },
        "suggested_edits": { "type": "array", "items": { "type": "string" } }
      }
    }
  }
}
