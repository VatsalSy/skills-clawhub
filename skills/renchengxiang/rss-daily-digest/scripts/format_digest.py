#!/usr/bin/env python3
"""
format_digest.py â€” å°† JSON æ ¼å¼çš„æ–‡ç« æ•°æ®æ ¼å¼åŒ–ä¸º Markdown æ—¥æŠ¥
"""
import argparse
import json
from datetime import datetime, timezone
from collections import defaultdict




EMOJI_MAP = {
    "Tech": "ğŸ”§", "Business": "ğŸ’¼", "World": "ğŸŒ",
    "AI": "ğŸ¤–", "Science": "ğŸ”¬", "Other": "ğŸ“Œ"
}




def format_digest(articles_data, template_path=None):
    """å°†æ–‡ç« æŒ‰åˆ†ç±»æ•´ç†æˆ Markdown æ ¼å¼æ—¥æŠ¥"""
    articles = articles_data.get("articles", [])
    errors = articles_data.get("errors", [])
    now = datetime.now(timezone.utc)


    # æŒ‰åˆ†ç±»åˆ†ç»„
    by_category = defaultdict(list)
    for a in articles:
        by_category[a.get("category", "Other")].append(a)


    # æ„å»º Markdown
    lines = []
    lines.append(
        f"# Daily Digest â€” {now.strftime('%Y-%m-%d')}\n"
    )
    lines.append(
        f"> **{len(articles)}** articles from "
        f"**{articles_data.get('sources_checked', '?')}** sources\n"
    )


    for category, items in sorted(by_category.items()):
        emoji = EMOJI_MAP.get(category, "ğŸ“Œ")
        lines.append(f"\n## {emoji} {category}\n")
        for item in items[:15]:  # æ¯åˆ†ç±»æœ€å¤š 15 ç¯‡
            title = item.get("title", "Untitled")
            url = item.get("url", "#")
            source = item.get("source", "Unknown")
            desc = item.get(
                "ai_summary", item.get("description", "")[:80]
            )
            lines.append(
                f"- **[{title}]({url})** â€” {desc} *({source})*"
            )


    # é”™è¯¯æŠ¥å‘Š
    if errors:
        lines.append(f"\n## Feed Errors ({len(errors)})\n")
        for err in errors:
            lines.append(f"- {err['source']}: {err['error']}")


    lines.append(
        f"\n---\n*Generated by RSS Daily Digest Skill "
        f"at {now.strftime('%Y-%m-%d %H:%M UTC')}*"
    )
    return "\n".join(lines)




def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('--input', required=True, help='JSON articles file')
    parser.add_argument('--template', help='Optional template path')
    args = parser.parse_args()


    with open(args.input, 'r', encoding='utf-8') as f:
        data = json.load(f)


    digest = format_digest(data, args.template)
    print(digest)




if __name__ == "__main__":
    main()
